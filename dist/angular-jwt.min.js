!function(){angular.module("angular-jwt",["angular-jwt.options","angular-jwt.interceptor","angular-jwt.jwt","angular-jwt.jwtAuthManager"]),function(t,e,n){"use strict";e.module("angular-jwt.jwtAuthManager",[]).constant("JWT_AUTH_EVENTS",{sessionTimeout:"jwt.tokenHasExpired",authenticated:"jwt.authenticated",notAuthenticated:"jwt.notAuthenticated"}).provider("jwtAuthManager",function(){var t=!1;this.$get=["$rootScope","$injector","$location","jwtHelper","jwtInterceptor","jwtOptions","JWT_AUTH_EVENTS",function(n,r,a,o,i,u,s){function c(t){var e=null;return e=Array.isArray(t)?r.invoke(t,this,{options:null}):t()}function h(t,n,a){if(console.log("NEXT STATE",n,a),Array.isArray(t)||e.isFunction(t))return r.invoke(t,m,{next:n,params:a});throw new Error("unauthenticatedRedirector must be a function")}function l(){var t=c(m.tokenGetter);return!!t&&!o.isTokenExpired(t)}function d(){t=!0}function f(){t=!1}function p(){n.$on("$locationChangeStart",function(){var t=c(m.tokenGetter);t&&(o.isTokenExpired(t)?n.$broadcast(s.sessionTimeout,t):(d(),n.$broadcast(s.authenticated,t)))})}function g(){n.$on(s.notAuthenticated,function(){h(m.unauthenticatedRedirector),f()})}function w(t,e,n){if(console.warn("Verifying Route",e,n,l()),!e)return!1;var r=e.$$route?e.$$route:e.data;r&&r.requiresLogin===!0&&(l()||(t.preventDefault(),h(m.unauthenticatedRedirector,e,n)))}var m=u.getConfig(),v=r.has("$state")?"$stateChangeStart":"$routeChangeStart";return n.$on(v,w),{authenticate:d,unauthenticate:f,getToken:function(){return c(m.tokenGetter)},redirect:function(t,e,n){return h(m.unauthenticatedRedirector,e,n)},checkAuthOnRefresh:p,redirectWhenUnauthenticated:g,isAuthenticated:l}}]})}(window,window.angular),angular.module("angular-jwt.interceptor",[]).provider("jwtInterceptor",function(){this.urlParam,this.authHeader,this.authPrefix,this.whiteListedDomains,this.tokenGetter;var t=this;this.$get=["$q","$injector","$rootScope","urlUtils","jwtOptions",function(e,n,r,a,o){function i(t){if(!a.isSameOrigin(t)&&!u.whiteListedDomains.length)throw new Error("As of v0.1.0, requests to domains other than the application's origin must be white listed. Use jwtOptionsProvider.config({ whiteListedDomains: [<domain>] }); to whitelist.");for(var e=a.urlResolve(t).hostname.toLowerCase(),n=0;n<u.whiteListedDomains.length;n++){var r=u.whiteListedDomains[n].toLowerCase();if(r===e)return!0}return!!a.isSameOrigin(t)}var u=angular.extend({},o.getConfig(),t);return{request:function(t){if(t.skipAuthorization||!i(t.url))return t;if(u.urlParam){if(t.params=t.params||{},t.params[u.urlParam])return t}else if(t.headers=t.headers||{},t.headers[u.authHeader])return t;var r=e.when(n.invoke(u.tokenGetter,this,{options:t}));return r.then(function(e){return e&&(u.urlParam?t.params[u.urlParam]=e:t.headers[u.authHeader]=u.authPrefix+e),t})},responseError:function(t){return 401===t.status&&r.$broadcast("unauthenticated",t),e.reject(t)}}}]}),angular.module("angular-jwt.jwt",[]).service("jwtHelper",["$window",function(t){this.urlBase64Decode=function(e){var n=e.replace(/-/g,"+").replace(/_/g,"/");switch(n.length%4){case 0:break;case 2:n+="==";break;case 3:n+="=";break;default:throw"Illegal base64url string!"}return t.decodeURIComponent(escape(t.atob(n)))},this.decodeToken=function(t){var e=t.split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var n=this.urlBase64Decode(e[1]);if(!n)throw new Error("Cannot decode the token");return angular.fromJson(n)},this.getTokenExpirationDate=function(t){var e=this.decodeToken(t);if("undefined"==typeof e.exp)return null;var n=new Date(0);return n.setUTCSeconds(e.exp),n},this.isTokenExpired=function(t,e){var n=this.getTokenExpirationDate(t);return e=e||0,null!==n&&!(n.valueOf()>(new Date).valueOf()+1e3*e)}}]),angular.module("angular-jwt.options",[]).provider("jwtOptions",function(){var t={};this.config=function(e){t=e},this.$get=function(){function e(){this.config=angular.extend({},n,t)}var n={urlParam:null,authHeader:"Authorization",authPrefix:"Bearer ",whiteListedDomains:[],tokenGetter:function(){return null},loginPath:"/",unauthenticatedRedirectPath:"/",unauthenticatedRedirector:["$location",function(t){t.path(this.unauthenticatedRedirectPath)}]};return e.prototype.getConfig=function(){return this.config},new e}}),angular.module("angular-jwt.interceptor").service("urlUtils",function(){function t(t){var e=t;return n.setAttribute("href",e),e=n.href,n.setAttribute("href",e),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}function e(e){var n=angular.isString(e)?t(e):e;return n.protocol===r.protocol&&n.host===r.host}var n=document.createElement("a"),r=t(window.location.href);return{urlResolve:t,isSameOrigin:e}})}();